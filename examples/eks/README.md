# EKS example deployment

EKS is a bit special because we don't have access
to the control plane nodes. Therefore, we need to disable Calico CNI plugin
to keep using the provided AWS VPC CNI plugin for networking.

Calico will provide the network policies engine.

## Quickstart

// TODO maybe a scaffolder that can create all required files?

Copy the files in `examples/eks` into the root of your own repository.
This repo will hold infrastructure state to be synced by ArgoCD once deployed.
Edit all the `values.yaml` file to configure the propert git repo URL for this repo (deduplication strategies coming soon).
Take some time to configure everything to your liking, such as the public URL for ArgoCD, the SSO for logging in and similar configuration
parameters.

### Secrets

MKP uses the [Kubernetes External Secrets] controller to pull secrets from a secure backed,
such as AWS Secrets Manager or Hashicorp Vault. A few secrets need to be provisioned before deploying the solution.

- **ArgoCD infrastructure repo credentials**  
  This secret holds the credentials (username/password, access token or SSH private key) that ArgoCD will use
  to pull from the infrastructure repository. You can configure the provided keys in the `git.credentialsSecret` section of
  [argocd.values.yaml]
- **ArgoCD secret**  
  This is the main secret for ArgoCD. The available keys are defined in the [ArgoCD documentation] for `argocd-secret.yaml`.
  *NOTE* `tls.crt` and `tls.key` will be generated by cert-manager and do not need to be provided.
- **CloudFlare credentials**  
  Several MKP modules integrates with CloudFlare for DNS management, notably external-dns (to automatically provision DNS records for cluster resources) and cert-manager (to perform the dns01 ACME challenge).
  A valid CloudFlare API Token must be provisioned and the reference to the secret must be configured in both [cert-manager.values.yaml] and [external-dns.values.yaml]

The External Secrets controller must be configured with an appropriate AWS role when reading values from Secrets Manager.  
For cluster running on EKS configure the `aws.eksRole` property in [external-secrets.values.yaml].  
For cluster running on EC2 configure the `aws.iamRole` property in [external-secrets.values.yaml].  
 
### Bootstrap
The cluster bootstrap needs to be performed manually since it will install the GitOps engine itself.

```bash
helmfile template | kubectl apply -f -
```

**WARNING** sometimes there can be race conditions between interdependent resources.
Rerun the previous stage if `kubectl` prints some errors to retry the failed resources.

Once everything has been created you should be able to access ArgoCD's UI at the configured address.
Now it is time to generate the real GitOps repository for this cluster and commit it to the repo.

```bash
# Generate the solution manifests
helmfile template --output-dir-template manifests

# Commit everything
git add --all . && git commit -m "Init cluster repo"

# Push to the VCS service
git push origin master
``` 

From now on, you can update the cluster by regenerating the manifests and pushing the new changes to the origin.
ArgoCD will pick up the manifests and start syncing them with the cluster every few minutes.

[Kubernetes External Secrets]: https://github.com/godaddy/kubernetes-external-secrets
[argocd.values.yaml]: ./argocd.values.yaml
[ArgoCD documentation]: https://argoproj.github.io/argo-cd/operator-manual/declarative-setup/
[cert-manager.values.yaml]: ./cert-manager.values.yaml
[external-dns.values.yaml]: ./external-dns.values.yaml  
[external-secrets.values.yaml]: ./external-secrets.values.yaml
