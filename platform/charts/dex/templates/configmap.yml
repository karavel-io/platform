apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "dex.name" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ include "dex.name" . }}
    {{- include "dex.labels" . | nindent 4 }}
data:
  config.yaml: |
    issuer: https://{{ .Values.publicHost }}
    storage:
      type: kubernetes
      config:
        inCluster: true
    web:
      https: 0.0.0.0:5556
      tlsCert: /etc/dex/tls/tls.crt
      tlsKey: /etc/dex/tls/tls.key
    grpc:
      addr: 0.0.0.0:5557
      tlsCert: /etc/dex/tls/tls.crt
      tlsKey: /etc/dex/tls/tls.key
    telemetry:
      http: 0.0.0.0:5558
    logger:
      level: "info"
      format: "json"
    connectors:
{{- .Values.connectors | toYaml | nindent 6 }}

    oauth2:
      skipApprovalScreen: true

    staticClients:
{{ .Values.clients  |toYaml | nindent 6}}

    enablePasswordDB: false
