- name: Ensure local applications directory exist
  delegate_to: localhost
  file:
    path: '{{ playbook_dir }}/{{ applications_dir }}'
    recurse: yes
    state: directory

- name: Generate ArgoCD application for {{ item.name }}
  include_tasks: generate.yml
  loop: '{{ components }}'
  vars:
    component_name: '{{ item.name }}'
    component_namespace: '{{ item.namespace }}'

- name: Generate bootstrap ArgoCD application
  delegate_to: localhost
  vars:
    name: bootstrap
    namespace: argocd
    repo: '{{ argocd.git.repo }}'
    path: '{{ applications_dir }}'
  template:
    src: application.yml.j2
    dest: '{{ playbook_dir }}/{{ applications_dir }}/bootstrap.yml'
    mode: 0644

- name: Generate ArgoCD infrastructure project
  delegate_to: localhost
  copy:
    src: project.yml
    dest: '{{ playbook_dir }}/{{ applications_dir }}/project.yml'
    mode: 0644

- name: Generate kustomization stack for boostrap ArgoCD application
  delegate_to: localhost
  vars:
    apps: '{{ components | map(attribute="name") | list }}'
  template:
    src: kustomization.yml.j2
    dest: '{{ playbook_dir }}/{{ applications_dir }}/kustomization.yml'
    mode: 0644

