- name: Add Karavel chart repo
  kubernetes.core.helm_repository:
    name: karavel
    repo_url: "https://charts.mikamai.com/karavel"

- name: Ensure monigoring namespace
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: monitoring
  when: init_namespaces

- include_role:
    name: install_component
  vars:
    component_name: tempo
    component_version: 0.1.0
    component_namespace: monitoring
    component_values:
      tempo:
        objectStore: '{{ tempo.store | default("local") }}'
        s3:
          bucket: '{{ tempo.s3.bucket if tempo.store == "s3" else omit }}'
          endpoint: '{{ (tempo.s3.endpoint | default(omit)) if tempo.store == "s3" else omit }}'
          region: '{{ tempo.s3.region if tempo.store == "s3" else omit }}'
          encrypted: '{{ (tempo.s3.encrypted | default(true)) if tempo.store == "s3" else omit }}'
          insecure: '{{ (tempo.s3.insecure | default(false)) if tempo.store == "s3" else omit }}'
          pathStyle: '{{ (tempo.s3.path_style | default(false)) if tempo.store == "s3" else omit }}'
          eksRole: '{{ (tempo.s3.eks_role | default(omit)) if tempo.store == "s3" else omit }}'
          iamRole: '{{ (tempo.s3.iam_role | default(omit)) if tempo.store == "s3" else omit }}'
