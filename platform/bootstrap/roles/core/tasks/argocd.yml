- name: Add Karavel chart repo
  kubernetes.core.helm_repository:
    name: karavel
    repo_url: "https://charts.mikamai.com/karavel"

- name: Ensure argocd namespace
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: argocd
  when: init_namespaces

- include_role:
    name: install_component
  vars:
    component_name: argocd
    component_version: 0.1.0
    component_namespace: argocd
    component_values:
      publicHost: '{{ argocd.public_host }}'
      secret: '{{ argocd.secret }}'
      credentialsSecret: '{{ argocd.credentials_secret }}'

      oidc:
        config:
          name: '{{ argocd.oidc.config.name }}'
          issuer: '{{ argocd.oidc.config.issuer }}'
          clientID: '{{ argocd.oidc.config.client_id }}'
          requestedScopes: '{{ argocd.oidc.config.requested_scopes }}'

      git:
        repo: '{{ argocd.git.repo }}'
