- name: Ensure external-secrets namespace
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: external-secrets
  when: init_namespaces

- include_role:
    name: install_component
  vars:
    component_name: external-secrets
    component_version: 0.1.0
    component_namespace: external-secrets
    component_values:
      pollingIntervalMs: '{{ secrets.polling_interval_ms | default(300000) }}'

      aws:
        enable: '{{ secrets.provider == "aws" }}'
        region: '{{ secrets.region if secrets.provider == "aws" else omit }}'
        defaultRegion: '{{ secrets.default_region if secrets.provider == "aws" else omit }}'
        eksRole: '{{ secrets.eks_role | default(omit) }}'
        iamRole: '{{ secrets.iam_role | default(omit) }}'

      vault:
        enable: '{{ secrets.provider == "vault" }}'
        address: '{{ secrets.address if secrets.provider == "vault" else "" }}'
        defaultMountPoint: '{{ secrets.default_mount_point if secrets.provider == "vault" else "" }}'
        defaultRole: '{{ secrets.default_role if secrets.provider == "vault" else "" }}'
        extraCertsSecret: '{{ secrets.extra_certs_secret_ref if secrets.provider == "vault" else "" }}'
