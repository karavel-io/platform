- name: Add Karavel chart repo
  kubernetes.core.helm_repository:
    name: karavel
    repo_url: "https://charts.mikamai.com/karavel"

- name: Ensure monitoring namespace
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: monitoring
  when: init_namespaces

- include_role:
    name: install_component
  vars:
    component_name: prometheus
    component_version: 0.1.0
    component_namespace: monitoring
    component_values:
      thanos:
        objectStore: '{{ prometheus.store | default("filesystem") }}'
        s3:
          bucket: '{{ prometheus.s3.bucket if prometheus.store == "s3" else omit }}'
          endpoint: '{{ (prometheus.s3.endpoint | default("s3.amazonaws.com")) if prometheus.store == "s3" else omit }}'
          region: '{{ prometheus.s3.region if prometheus.store == "s3" else omit }}'
          encrypted: '{{ (prometheus.s3.encrypted | default(true)) if prometheus.store == "s3" else omit }}'
          insecure: '{{ (prometheus.s3.insecure | default(false)) if prometheus.store == "s3" else omit }}'
          eksRole: '{{ (prometheus.s3.eks_role | default(omit)) if prometheus.store == "s3" else omit }}'
          iamRole: '{{ (prometheus.s3.iam_role | default(omit)) if prometheus.store == "s3" else omit }}'
