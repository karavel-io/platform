- name: Add Karavel chart repo
  kubernetes.core.helm_repository:
    name: karavel
    repo_url: "https://charts.mikamai.com/karavel"

- name: Ensure monitoring namespace
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: monitoring
  when: init_namespaces

- include_role:
    name: install_component
  vars:
    component_name: loki
    component_version: 0.1.0
    component_namespace: monitoring
    component_values:
      loki:
        objectStore: '{{ loki.store | default("filesystem") }}'
        s3:
          bucket: '{{ loki.s3.bucket if loki.store == "s3" else omit }}'
          endpoint: '{{ (loki.s3.endpoint | default(omit)) if loki.store == "s3" else omit }}'
          region: '{{ loki.s3.region if loki.store == "s3" else omit }}'
          encrypted: '{{ (loki.s3.encrypted | default(true)) if loki.store == "s3" else omit }}'
          insecure: '{{ (loki.s3.insecure | default(false)) if loki.store == "s3" else omit }}'
          pathStyle: '{{ (loki.s3.path_style | default(false)) if loki.store == "s3" else omit }}'
          eksRole: '{{ (loki.s3.eks_role | default(omit)) if loki.store == "s3" else omit }}'
          iamRole: '{{ (loki.s3.iam_role | default(omit)) if loki.store == "s3" else omit }}'
      jaeger:
        enable: '{{ loki.jaeger.enabled | default(false) }}'
        host: '{{ loki.jaeger.host | default(omit) }}'
        endpoint: '{{ loki.jaeger.endpoint | default(omit) }}'
        samplerType: '{{ loki.jaeger.sampler_type | default(omit) }}'
        samplerParam: '{{ loki.jaeger.sampler_type | default(omit) }}'
