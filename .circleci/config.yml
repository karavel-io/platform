version: 2.1

workflows:
  platform:
    jobs:
      - helm-lint
      - docs-build:
          requires:
            - helm-lint
          filters:
            branches:
              only:
                - master
  cli:
    jobs:
      - cli-verify

jobs:
  helm-lint:
    docker:
      - image: quay.io/helmpack/chart-testing:v3.3.1
    steps:
      - checkout
      - run:
          name: Lint charts
          command: ct lint --all --chart-dirs platform/charts

  docs-build:
    docker:
      - image: squidfunk/mkdocs-material:6.1.6
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "95:21:09:e7:b3:a2:00:1a:1e:19:30:69:6b:2f:83:b5"
      - run:
          name: Publish docs to GitHub Pages
          command: |
            mkdocs gh-deploy --strict --force --message "[ci skip] Deployed 7881965 with MkDocs version: 1.1.2"

  cli-verify:
    working_directory: ~/project/cli
    docker:
      - image: circleci/golang:1.15
    steps:
      - checkout:
          path: ~/project
      - restore_cache:
          keys:
            - go-mod-v4-{{ checksum "go.sum" }}
      - run:
          name: Build CLI
          command: make build
      - save_cache:
          key: go-mod-v4-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run: mkdir -p /tmp/test-results
      - run:
          name: Run tests
          command: |
            PACKAGE_NAMES=$(go list ./cli/... | circleci tests split --split-by=timings --timings-type=classname)
            gotestsum --junitfile /tmp/test-results/gotestsum-report.xml -- $PACKAGE_NAMES
      - run:
          name: Run linter
          command: make vet
      - store_artifacts:
          path: /tmp/test-results
          destination: raw-test-output

      - store_test_results:
          path: /tmp/test-results
